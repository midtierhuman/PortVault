<section class="pv-portfolios">
  @if (!selectedPortfolio()) {
  <h2>My Portfolios</h2>

  @if (isLoading()) {
  <div class="loading-container">
    <mat-spinner></mat-spinner>
  </div>
  } @else if (portfolios().length > 0) {
  <mat-card>
    <table mat-table [dataSource]="portfolios()">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let p">{{ p.name }}</td>
      </ng-container>

      <ng-container matColumnDef="invested">
        <th mat-header-cell *matHeaderCellDef>Invested</th>
        <td mat-cell *matCellDef="let p">{{ p.invested | currency : 'INR' }}</td>
      </ng-container>

      <ng-container matColumnDef="current">
        <th mat-header-cell *matHeaderCellDef>Current</th>
        <td mat-cell *matCellDef="let p">{{ p.current | currency : 'INR' }}</td>
      </ng-container>

      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let p">
          <button mat-button color="primary" (click)="selectPortfolio(p)">View Details</button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['name', 'invested', 'current', 'action']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['name', 'invested', 'current', 'action']"></tr>
    </table>
  </mat-card>
  } @else {
  <mat-card>
    <p class="empty-message">No portfolios found. Create your first portfolio to get started!</p>
  </mat-card>
  } } @else {
  <div class="portfolio-details">
    <div class="details-header">
      <button mat-icon-button (click)="backToList()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2>{{ selectedPortfolio()?.name }}</h2>
    </div>

    @if (isLoadingDetails()) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
    } @else {
    <mat-card>
      <mat-tab-group>
        <!-- Holdings Tab -->
        <mat-tab label="Holdings">
          @if (holdings().length > 0) {
          <table mat-table [dataSource]="holdings()" class="details-table">
            <ng-container matColumnDef="symbol">
              <th mat-header-cell *matHeaderCellDef>Symbol</th>
              <td mat-cell *matCellDef="let h">{{ h.symbol }}</td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Quantity</th>
              <td mat-cell *matCellDef="let h">{{ h.qty }}</td>
            </ng-container>

            <ng-container matColumnDef="avgPrice">
              <th mat-header-cell *matHeaderCellDef>Avg Price</th>
              <td mat-cell *matCellDef="let h">{{ h.avgPrice | currency : 'INR' }}</td>
            </ng-container>

            <ng-container matColumnDef="ltp">
              <th mat-header-cell *matHeaderCellDef>LTP</th>
              <td mat-cell *matCellDef="let h">{{ h.ltp | currency : 'INR' }}</td>
            </ng-container>

            <ng-container matColumnDef="invested">
              <th mat-header-cell *matHeaderCellDef>Invested</th>
              <td mat-cell *matCellDef="let h">{{ h.invested | currency : 'INR' }}</td>
            </ng-container>

            <ng-container matColumnDef="current">
              <th mat-header-cell *matHeaderCellDef>Current</th>
              <td mat-cell *matCellDef="let h">{{ h.current | currency : 'INR' }}</td>
            </ng-container>

            <ng-container matColumnDef="pnl">
              <th mat-header-cell *matHeaderCellDef>P&L</th>
              <td
                mat-cell
                *matCellDef="let h"
                [class.positive]="h.pnl >= 0"
                [class.negative]="h.pnl < 0"
              >
                {{ h.pnl | currency : 'INR' }} ({{ h.pnlPercent | number : '1.2-2' }}%)
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'symbol',
                'quantity',
                'avgPrice',
                'ltp',
                'invested',
                'current',
                'pnl'
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: ['symbol', 'quantity', 'avgPrice', 'ltp', 'invested', 'current', 'pnl']
              "
            ></tr>
          </table>
          } @else {
          <p class="empty-message">No holdings found in this portfolio.</p>
          }
        </mat-tab>

        <!-- Transactions Tab -->
        <mat-tab label="Transactions">
          @if (transactions().length > 0) {
          <table mat-table [dataSource]="transactions()" class="details-table">
            <ng-container matColumnDef="symbol">
              <th mat-header-cell *matHeaderCellDef>Symbol</th>
              <td mat-cell *matCellDef="let t">{{ t.symbol }}</td>
            </ng-container>

            <ng-container matColumnDef="tradeType">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let t">
                <span [class.buy]="t.tradeType === 'Buy'" [class.sell]="t.tradeType === 'Sell'">
                  {{ t.tradeType }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Quantity</th>
              <td mat-cell *matCellDef="let t">{{ t.quantity }}</td>
            </ng-container>

            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>Price</th>
              <td mat-cell *matCellDef="let t">{{ t.price | currency : 'INR' }}</td>
            </ng-container>

            <ng-container matColumnDef="tradeDate">
              <th mat-header-cell *matHeaderCellDef>Trade Date</th>
              <td mat-cell *matCellDef="let t">{{ t.tradeDate | date : 'short' }}</td>
            </ng-container>

            <ng-container matColumnDef="segment">
              <th mat-header-cell *matHeaderCellDef>Segment</th>
              <td mat-cell *matCellDef="let t">{{ t.segment }}</td>
            </ng-container>

            <ng-container matColumnDef="tradeID">
              <th mat-header-cell *matHeaderCellDef>Trade ID</th>
              <td mat-cell *matCellDef="let t">{{ t.tradeID }}</td>
            </ng-container>

            <ng-container matColumnDef="action">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let t">
                <button mat-icon-button color="primary" (click)="editTransaction(t)">
                  <mat-icon>edit</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'symbol',
                'tradeType',
                'quantity',
                'price',
                'tradeDate',
                'segment',
                'tradeID',
                'action'
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: [
                  'symbol',
                  'tradeType',
                  'quantity',
                  'price',
                  'tradeDate',
                  'segment',
                  'tradeID',
                  'action'
                ]
              "
            ></tr>
          </table>
          } @else {
          <p class="empty-message">No transactions found in this portfolio.</p>
          }
        </mat-tab>
      </mat-tab-group>
    </mat-card>
    }
  </div>
  }
</section>
